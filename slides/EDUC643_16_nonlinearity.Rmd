---
title: "Interactions and non-linearity"
subtitle: "EDUC 643: Unit 5 Part II"
author: "David D. Liebowitz"
#date: "`r format(Sys.time(), '%d %B %Y')`"
output:
  xaringan::moon_reader:
    css: ['default', 'uo', 'ki-fonts', 'my_custom.css', 'xaringanthemer.css']
    # self_contained: true
    nature:
      highlightStyle: github
      highlightLines: true
      countIncrementalSlides: false
---

```{R, setup, include = F}
library(pacman)
p_load(here, tidyverse, xaringan, knitr, kableExtra, haven, broom, xaringanthemer, reshape2, car, modelsummary)

i_am("slides/EDUC643_16_nonlinearity.Rmd")



red_pink <- "#e64173"
turquoise = "#20B2AA"
orange = "#FFA500"
red = "#fb6107"
blue = "#3b3b9a"
green = "#8bb174"
grey_light = "#B3B3B3"
grey_mid = "#7F7F7F"
grey_dark = "grey20"
purple = "#6A5ACD"
slate = "#314f4f"

extra_css <- list(
  ".red"   = list(color = "red"),
  ".blue"  =list(color = "blue"),
  ".red-pink" = list(color= "#e64173"),
  ".gray" = list(color= "#B3B3B3"),
  ".purple" = list(color = "purple"),
  ".orange" = list(color = "#FFA500"),
  ".small" = list("font-size" = "90%"),
  ".large" = list("font-size" = "120%"),
  ".tiny" = list("font-size" = "75%"),
  ".tiny2" = list("font-size" = "50%"))


write_extra_css(css = extra_css, outfile = "my_custom.css")

options(htmltools.dir.version = FALSE)

hook_output <- knit_hooks$get("output")
knit_hooks$set(output = function(x, options) {
  lines <- options$output.lines
  if (is.null(lines)) {
    return(hook_output(x, options))  # pass to default hook
  }
  x <- unlist(strsplit(x, "\n"))
  more <- "..."
  if (length(lines)==1) {        # first n lines
    if (length(x) > lines) {
      # truncate the output, but add ....
      x <- c(head(x, lines), more)
    }
  } else {
    x <- c(more, x[lines], more)
  }
  # paste these lines together
  x <- paste(c(x, ""), collapse = "\n")
  hook_output(x, options)
})

knitr::opts_chunk$set(warning = FALSE,
                      message = FALSE,
                      echo = FALSE,
                      fig.align = "center",
                      fig.height = 6.5,
                      fig.width = 10)


```

# Roadmap
```{r, echo=F, out.width="90%"}
include_graphics("Roadmap5.jpg")

dibels <- read.csv(here("data/dibels.csv"))
dibels_long <- read.csv(here("data/dibels_long.csv"))

```

---
# Goals of the unit

- Describe in writing and verbally the assumptions we violate when we fit a non-linear relationship in a linear model
- Transform non-linear relationships into linear ones by using logarithmic scales 
- Estimate regression models using logarithmic scales and interpret the results
- Describe in writing and verbally the concept of statistical interaction
- Estimate and interpret regression models with interactions between categorical and continuous predictors
- Visualize interaction effects graphically
- Describe statistical power and Type II error challenges resulting from interactions
- Estimate models with quadratic and higher-order polynomial terms

---
class: middle, inverse

# Non-linearity

---
# $ and learning
```{r}
pisa <- read.csv(here("data/pisa.csv")) %>% select(c("Country", "total_spending", "read_score"))
pisa$total_spending <- as.numeric(gsub(",", "", pisa$total_spending))

lin <- ggplot(pisa, aes(total_spending, read_score)) + 
          geom_point() +
          theme(panel.background = element_rect(fill = 'lightblue', colour = 'lightblue'),
          plot.background = element_rect(fill = "lightblue"),
          panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
          axis.line = element_line(size = .6, colour = "black")) +
          ylim(300, 600) +
          ylab("PISA reading score") + xlab("Total spending, age 6-15 ($)") + 
          scale_x_continuous(label=scales::comma)
lin
```

---
# $ and learning
```{r}
lin + 
      geom_smooth(method='lm', se=F)
```

---
# $ and learning
```{r}
lm_eqn <- function(pisa){
    m <- lm(read_score ~ total_spending, pisa);
    eq <- substitute(italic(y) == a + b %.% italic(x)*","~~italic(r)^2~"="~r2, 
         list(a = format(unname(coef(m)[1]), digits = 2),
              b = format(unname(coef(m)[2]), digits = 2),
             r2 = format(summary(m)$r.squared, digits = 3)))
    as.character(as.expression(eq));
}

lin + 
      geom_smooth(method='lm', se=F) +
      geom_text(x = 275000, y = 500, label = lm_eqn(pisa), parse=TRUE)
```

--
.small[***If assumptions hold***, each $10,000 diff in total spending associated, on average, with 4.3 scale score point difference in reading scores.]

--
.small[.blue[**But do they?**]]

---
# Linear?
```{r, echo=T, fig.height=4}
# Fit the model
fit <- lm(read_score ~ total_spending, data=pisa)
# Generate residual vs fitted plot
pisa$resid <- resid(fit)
pisa$fitted <- fitted(fit)
ggplot(pisa, aes(fitted, resid)) + geom_point() +
  geom_hline(yintercept = 0, color = "red", linetype="dashed")
```

---
```{r}
include_graphics("pisa_spending.png")
```

---
# Make it nice
```{r}
library(ggflags)
library(countrycode)
pisa$iso2 <- countrycode::countrycode(pisa$Country, "country.name", "iso2c")
    pisa$iso2 <- tolower(pisa$iso2)

flag <- ggplot(pisa, aes(total_spending, read_score)) + 
    geom_point() + geom_flag(aes(country=iso2), show.legend=F) +
    theme(panel.background = element_rect(fill = 'lightblue', colour = 'lightblue'),
          plot.background = element_rect(fill = "lightblue"),
          panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
          axis.line = element_line(size = .6, colour = "black")) +
    ylab("PISA reading score") + xlab("Total spending, age 6-15 ($)") + 
    scale_x_continuous(label=scales::comma)

flag
```

--
At low levels of spending the relationship between ***total_spending*** and ***read_score*** has a big magnitude. At higher levels of spending, it seems much more modest (negative?).

---
class: middle, inverse

# Logarithmic transformations in X

---
# Log transformations


We can posit a non-linear relationship between X and Y in the population
Any non-linear relationship implies that the relationship between X and Y is relative, not absolute (the slope is non-constant)
Transformations allow us to fit non-linear relationship with machinery of linear model

---
# Log transformations in life

---
# A log `r emo::ji("wood")` you say??

Expressed as: “Log base 2 of 32 is 5” or “Log base 10 of 1,000 is 3”

Log base anything(1) is = 0

Taking logs is a monotonic transformation, doesn’t change the order


---
# $ and scores?
```{r}
flag +
  scale_x_log10(breaks=c(10000, 50000, 100000, 300000), label=scales::comma)
```

---
## Regress reading on log(*total_spending*)
```{r}
summary(lm(read_score ~ log(total_spending), data=pisa))
```

---
# Conceptually

In ed/dev psych this kind of curve is called “learning curve” –represents standard rate of learning
More broadly, increasing exponential decay or diminishing marginal returns

---
# Interpret

---
class: middle, inverse

# Log transformations in Y

## aka Exponential growth curve


---
class: middle, inverse

# Log-log transformations

## aka proportional growth



---
class: middle, inverse

# Quadratic terms: a special kind of interaction

---
class: middle, inverse

# Higher-order polynomials


---
# Other approaches
```{r}
### fix this
flag +
    geom_smooth(method='lm', formula = y ~ splines::bs(x))


```

---
class: middle, inverse
# Synthesis and wrap-up


---
# Different models

---
# Rule of the Bulge
---
## Putting non-linearity together


---
# Goals of the unit

- Describe in writing and verbally the assumptions we violate when we fit a non-linear relationship in a linear model
- Transform non-linear relationships into linear ones by using logarithmic scales 
- Estimate regression models using logarithmic scales and interpret the results
- Describe in writing and verbally the concept of statistical interaction
- Estimate and interpret regression models with interactions between categorical and continuous predictors
- Visualize interaction effects graphically
- Describe statistical power and Type II error challenges resulting from interactions
- Estimate models with quadratic and higher-order polynomial terms

---
# To-Dos

### Reading: 
- **Finish by **: LSWR Chapter 

### Assignment 4:
- Due Feb. 28, 11:59pm

### Assignment 5:
- Due
